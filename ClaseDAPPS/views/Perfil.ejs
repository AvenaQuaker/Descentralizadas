<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mi Perfil</title>

    <link rel="stylesheet" href="/css/perfilTW.css">
    <script src="/sweetalert2/sweetalert2.all.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>

<body class="min-h-screen bg-center bg-cover bg-[url('/images/fondoBlock.jpg')] font-[Montserrat]">
   <a href="/" 
    class="inline-block bg-yellow-500 hover:bg-yellow-600 text-black font-bold px-5 py-2 rounded-lg mt-6 mx-5">
        ‚Üê Volver a la Tienda
    </a>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="max-w-5xl mx-auto mt-12 p-8 bg-black/60 backdrop-blur-xl rounded-xl shadow-2xl">

        <!-- HEADER PERFIL -->
        <div class="flex items-center gap-8 border-b border-yellow-500 pb-6">

            <!-- FOTO -->
            <img 
                src="<%= person.imageUrl || '/icons/User.svg' %>"
                class="w-32 h-32 rounded-full border-4 border-yellow-400 object-cover shadow-xl"
            >

            <!-- DATOS -->
            <div class="flex flex-col gap-1">
                <h1 class="text-4xl font-extrabold text-yellow-400 tracking-wide">
                    <%= person.username || 'Usuario sin nombre' %>
                </h1>

                <p class="text-gray-300 mt-1 text-lg">
                    <span class="font-semibold text-yellow-300">Email:</span>
                    <%= person.email || 'No definido' %>
                </p>

                <p class="text-gray-300 text-sm truncate max-w-md">
                    <span class="font-semibold text-yellow-300">Wallet:</span>
                    <%= person.wallet %>
                </p>

                <p class="text-green-400 mt-2 text-lg font-semibold">
                    Saldo: <%= saldo %> ETH
                </p>
            </div>

            <!-- EDITAR -->
            <button
                id="editProfileBtn"
                class="ml-auto bg-yellow-500 hover:bg-yellow-400 active:scale-95 transition-all text-black font-bold px-6 py-3 rounded-lg shadow-md"
            >
                Editar perfil
            </button>

        </div>

        <!-- SECCI√ìN MIS PEL√çCULAS -->
        <h2 class="text-3xl font-bold text-yellow-400 mt-10 flex items-center gap-3">
            üé¨ Mis Pel√≠culas
        </h2>

        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-8 mt-6">

            <% if (movies.length === 0) { %>
                <div class="col-span-3 text-center text-gray-300 text-xl py-10">
                    A√∫n no has comprado nada üò¢
                </div>
            <% } %>

            <% movies.forEach(movie => { %>

            <!-- CARD DE PEL√çCULA -->
            <div class="bg-blue-900/90 border-2 border-yellow-400 rounded-xl overflow-hidden shadow-xl hover:scale-[1.03] transition-transform">

                <img src="<%= movie.imageUrl %>" class="h-56 w-full object-cover">

                <div class="p-4">
                    <h3 class="text-xl font-bold text-yellow-300">
                        <%= movie.name %>
                    </h3>

                    <p class="text-gray-300 text-sm mt-2">
                        Precio pagado:
                        <span class="text-green-400 font-semibold">
                            <%= movie.price %> ETH
                        </span>
                    </p>

                    <p class="text-gray-400 text-xs mt-1">
                        Comprado el:
                        <%= new Date(movie.timestamp * 1000).toLocaleString() %>
                    </p>
                </div>
            </div>

            <% }) %>

        </div>

    </div>

<!-- ==========================
     SWEET ALERT EDITAR PERFIL
=========================== -->
<script>
document.getElementById("editProfileBtn").addEventListener("click", async () => {

    const { value: formValues } = await Swal.fire({
        title: "Editar Perfil",
        background: "#111",
        color: "#fff",
        html: `
            <input id="swal-username" placeholder="Nombre de usuario" class="swal2-input" value="<%= person.username %>">
            <input id="swal-email" placeholder="Correo electr√≥nico" class="swal2-input" value="<%= person.email %>">
            <input id="swal-image" placeholder="URL de imagen" class="swal2-input" value="<%= person.imageUrl %>">
        `,
        confirmButtonText: "Guardar cambios",
        confirmButtonColor: "#facc15",
        showCancelButton: true,
        cancelButtonText: "Cancelar",
        focusConfirm: false,

        preConfirm: () => {
            const username = document.getElementById("swal-username").value.trim();
            const email = document.getElementById("swal-email").value.trim();
            const imageUrl = document.getElementById("swal-image").value.trim();

            if (!username || !email) {
                Swal.showValidationMessage("Nombre y correo son obligatorios");
                return false;
            }

            return { username, email, imageUrl };
        }
    });

    if (!formValues) return;

    try {
        Swal.fire({
            title: "Guardando cambios...",
            background: "#111",
            color: "#fff",
            didOpen: () => Swal.showLoading(),
            allowOutsideClick: false,
        });

        const res = await fetch("/api/personal/updateBasic", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                id: "<%= person.id %>",
                email: formValues.email,
                username: formValues.username,
                imageUrl: formValues.imageUrl,
                account: "<%= person.wallet %>"
            })
        });

        const data = await res.json();

        if (!data.success) {
            return Swal.fire({
                icon: "error",
                title: "Error",
                text: data.message,
                background: "#111",
                color: "#fff"
            });
        }

        Swal.fire({
            icon: "success",
            title: "Perfil actualizado",
            background: "#111",
            color: "#fff",
            timer: 1500,
            showConfirmButton: false
        });

        setTimeout(() => location.reload(), 1500);

    } catch (err) {
        Swal.fire({
            icon: "error",
            title: "Error",
            text: "No se pudo conectar al servidor",
            background: "#111",
            color: "#fff"
        });
    }

});

</script>

</body>
</html>
