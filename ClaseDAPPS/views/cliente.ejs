<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Tienda - Cliente</title>
    <link rel="stylesheet" href="/css/clienteTW.css">
    <script src="/sweetalert2/sweetalert2.all.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="/js/walletAbi.js"></script>
</head>
<body class="min-h-screen bg-center bg-cover bg-[url('/images/fondoBlock.jpg')]" >

    <!-- NAVBAR ESTILO BLOCKBUSTER -->
    <nav class="bb-blue shadow-lg px-6 py-4 flex justify-between items-center border-b-4 border-yellow-400">
        <h1 class="text-3xl blockbuster-title bb-yellow drop-shadow-lg text-white font-TiltWarp">
            BLOCKBUSTER STORE
        </h1>

        <form action="/Perfil" method="GET">
            <button 
                class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg 
                font-semibold shadow-md transition">
                Perfil
            </button>
        </form>

    </nav>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="max-w-7xl mx-auto px-6 py-10 backdrop-blur-sm rounded-xl mt-10 shadow-xl">

        <!-- GRID DE PRODUCTOS ESTILO BLOCKBUSTER -->
        <div class="grid gap-8 
            grid-cols-1 
            sm:grid-cols-2 
            md:grid-cols-3 
            lg:grid-cols-4">

            <% products.forEach(p => { %>

                <div class="bg-[#0032A0] rounded-xl border-4 border-yellow-400 shadow-2xl 
                            overflow-hidden transition transform hover:scale-105 flex flex-col">

                    <!-- "Carátula" de película -->
                    <div class="h-48 bg-center bg-cover flex items-center justify-center" style="background-image: url('<%= p.imageUrl %>');">
                        <span class="text-yellow-400 text-xl font-bold blockbuster-title text-center px-2">
                            <%= p.name %>
                        </span>
                    </div>

                    <!-- CONTENIDO -->
                    <div class="p-4 text-white flex flex-col flex-grow">

                        <h3 class="text-xl font-bold bb-yellow blockbuster-title">
                            <%= p.name %>
                        </h3>

                        <p class="text-gray-200 mt-1 text-sm">
                            Código de película: <%= p.id %>
                        </p>

                        <p class="text-yellow-300 font-bold mt-3 text-lg">
                            <%= p.price %> ETH
                        </p>

                        <% if (!p.active) { %>

                            <span class="mt-4 py-2 text-center bg-gray-300 text-gray-900 font-semibold rounded-lg">
                                No disponible
                            </span>

                        <% } else { %>

                            <!-- BOTÓN AL ESTILO BLOCKBUSTER -->
                            <form  class="mt-4">
                                <input type="hidden" name="productId" value="<%= p.id %>">

                                <button class="btn-rentar border-amber-500 bg-blue-500 p-3 rounded-2xl text-amber-50 font-Montserrat font-bold" type="button" 
                                    onclick="buyMovie('<%= p.id %>', '<%= p.price %>')">
                                    RENTAR AHORA
                            </button>

                            </form>

                        <% } %>

                    </div>
                </div>

            <% }) %>

        </div>

    </div>
<script>
async function buyMovie(productId, priceInEth) {
    try {
        if (!window.ethereum) {
            return Swal.fire("Error", "Necesitas MetaMask instalado.", "error");
        }

        // 1) Conectar MetaMask
        await ethereum.request({ method: "eth_requestAccounts" });
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        const signer   = provider.getSigner();
        const userWallet = await signer.getAddress();
            console.log("Pagando desde:", userWallet)
        // 2) Comprobar saldo
        const balance = await provider.getBalance(userWallet);
        const needed = ethers.utils.parseEther(String(priceInEth));

        if (balance.lt(needed)) {
            return Swal.fire({
                icon: "error",
                title: "Saldo insuficiente",
                text: "Tu cuenta no tiene ETH para completar la compra."
            });
        }

        // 3) Contrato de la tienda
        const contractAddress = "<%= walletContract %>";  // lo pasas desde el render
        const abi = window.WALLET_ABI;                    // cargado en un <script>

        const contract = new ethers.Contract(contractAddress, abi, signer);

        Swal.fire({
            title: "Procesando compra...",
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        // 4) Comprar el producto *desde la wallet del usuario*
        const tx = await contract.buyProduct(productId, {
            value: ethers.utils.parseEther(String(priceInEth))
        });
        await tx.wait();

        // 5) Registrar compra en tu backend / PersonalManager
        const res = await fetch("/api/personal/registerPurchase", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                wallet: userWallet,
                productId,
                amountPaid: String(priceInEth)
            })
        });

        const data = await res.json();
        Swal.close();

        if (!data.success) {
            return Swal.fire("Error", data.message, "error");
        }

        Swal.fire({
            icon: "success",
            title: "Compra realizada",
            text: "La película ha sido añadida a tu perfil.",
            timer: 1800,
            showConfirmButton: false
        });

        setTimeout(() => location.href = "/perfil", 1600);

    } catch (err) {
        console.error(err);
        Swal.fire("Error", err.message || "No se pudo completar la compra.", "error");
    }
}

</script>

</body>
</html>
