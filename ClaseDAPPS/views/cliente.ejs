<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Tienda - Cliente</title>
    <link rel="stylesheet" href="/css/clienteTW.css">
    <script src="/sweetalert2/sweetalert2.all.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="/js/walletAbi.js"></script>
</head>
<body class="min-h-screen bg-center bg-cover bg-[url('/images/fondoBlock.jpg')]" >
        <nav class="bg-black/80 text-yellow-400 px-6 py-4 flex items-center justify-between">
        <h1 class="text-2xl font-extrabold tracking-wide">BLOCKBUSTER DAPP</h1>

        <div class="flex items-center gap-4">
            <% if (role === 'Admin' || role === 'Manager') { %>
                <div class="bg-yellow-500/10 border border-yellow-400 px-4 py-2 rounded-lg text-sm">
                    <span class="font-semibold">Balance tienda:</span>
                    <span id="store-balance"><%= storeBalance %> ETH</span>
                </div>

                <button id="withdrawBtn"
                    class="bg-yellow-400 text-black font-bold px-4 py-2 rounded-lg hover:bg-yellow-300 transition">
                    Retirar fondos
                </button>
            <% } %>

            <a href="/perfil"
                class="bg-blue-500 text-white font-semibold px-4 py-2 rounded-lg hover:bg-blue-400 transition">
                Mi Perfil
            </a>

            <form action="/logout" method="POST">
                <button
                    class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition">
                    Cerrar sesión
                </button>
            </form>
        </div>
    </nav>
    <div class="max-w-7xl mx-auto px-6 py-10 backdrop-blur-sm rounded-xl mt-10 shadow-xl">

        <div class="grid gap-8 
            grid-cols-1 
            sm:grid-cols-2 
            md:grid-cols-3 
            lg:grid-cols-4">

            <% products.forEach(p => { %>

                <div class="bg-blue-900 border-2 border-yellow-400 rounded-xl overflow-hidden shadow-xl">

    <img src="<%= p.imageUrl %>" class="h-48 w-full object-cover">

    <div class="p-4">
        <h3 class="text-xl font-bold text-yellow-400"><%= p.name %></h3>

        <p class="text-gray-300 text-sm mt-2">
            Precio: <span class="text-green-400"><%= p.price %> ETH</span>
        </p>

        <!-- ESTA COSA SOLO SI ERES ADMIN -->
        <% if (role === 'Admin') { %>
            <button 
                class="mt-2 w-full bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-2 rounded-lg"
                onclick="editProduct('<%= p.id %>', '<%= p.name %>', '<%= p.description %>', '<%= p.price %>', '<%= p.stock %>', '<%= p.imageUrl %>')">
                Editar
            </button>
            <button 
                class="mt-2 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded-lg"
                onclick="deleteProduct('<%= p.id %>')">
                Eliminar
            </button>
        <% } else { %>
            <button class="mt-2 w-full bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-2 rounded-lg"
                onclick="buyMovie('<%= p.id %>', '<%= p.price %>')">
                RENTAR AHORA
            </button>
        <% } %>

    </div>
</div>

            <% }) %>

        </div>

    </div>

<% if (role === 'Admin') { %>
<button onclick="addProduct()"
    class="fixed bottom-10 right-10 bg-yellow-500 hover:bg-yellow-600 text-black font-bold px-5 py-4 rounded-full shadow-xl text-xl">
    ➕
</button>
<% } %>

<script>
async function buyMovie(productId, priceInEth) {
    try {
        if (!window.ethereum) {
            return Swal.fire("Error", "Necesitas MetaMask instalado.", "error");
        }

        await ethereum.request({ method: "eth_requestAccounts" });
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        const signer   = provider.getSigner();
        const userWallet = await signer.getAddress();
            console.log("Pagando desde:", userWallet)

        const balance = await provider.getBalance(userWallet);
        const needed = ethers.utils.parseEther(String(priceInEth));

        if (balance.lt(needed)) {
            return Swal.fire({
                icon: "error",
                title: "Saldo insuficiente",
                text: "Tu cuenta no tiene ETH para completar la compra."
            });
        }

        const contractAddress = "<%= walletContract %>"; 
        const abi = window.WALLET_ABI;                   

        const contract = new ethers.Contract(contractAddress, abi, signer);

        Swal.fire({
            title: "Procesando compra...",
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        const tx = await contract.buyProduct(productId, {
            value: ethers.utils.parseEther(String(priceInEth))
        });
        await tx.wait();

        const res = await fetch("/api/personal/registerPurchase", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                wallet: userWallet,
                productId,
                amountPaid: String(priceInEth)
            })
        });

        const data = await res.json();
        Swal.close();

        if (!data.success) {
            return Swal.fire("Error", data.message, "error");
        }

        Swal.fire({
            icon: "success",
            title: "Compra realizada",
            text: "La película ha sido añadida a tu perfil.",
            timer: 1800,
            showConfirmButton: false
        });

        setTimeout(() => location.href = "/perfil", 1600);

    } catch (err) {
        console.error(err);
        Swal.fire("Error", err.message || "No se pudo completar la compra.", "error");
    }
}

async function editProduct(id, name, description, price, stock, imageUrl) {
    
    const { value: formValues } = await Swal.fire({
        title: "Editar Producto",
        background: "#111",
        color: "#fff",
        width: "600px",
        html: `
            <input id="prod-name" class="swal2-input" placeholder="Nombre" value="${name}">
            <input id="prod-desc" class="swal2-input" placeholder="Descripción" value="${description}">
            <input id="prod-price" class="swal2-input" placeholder="Precio (ETH)" value="${price}">
            <input id="prod-stock" class="swal2-input" placeholder="Stock" value="${stock}">
            <input id="prod-image" class="swal2-input" placeholder="URL Imagen" value="${imageUrl}">
        `,
        confirmButtonText: "Guardar cambios",
        confirmButtonColor: "#facc15",
        showCancelButton: true,
        cancelButtonText: "Cancelar",
        focusConfirm: false,
        preConfirm: () => {
            return {
                name: document.getElementById("prod-name").value,
                description: document.getElementById("prod-desc").value,
                price: document.getElementById("prod-price").value,
                stock: document.getElementById("prod-stock").value,
                imageUrl: document.getElementById("prod-image").value
            }
        }
    });

    if (!formValues) return;

    Swal.fire({
        title: "Actualizando...",
        background: "#111",
        color: "#fff",
        didOpen: () => Swal.showLoading(),
        allowOutsideClick: false
    });

    const res = await fetch(`/api/wallet/products/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(formValues)
    });

    const data = await res.json();
    Swal.close();

    if (!data.success) {
        return Swal.fire("Error", data.error, "error");
    }

    Swal.fire({
        icon: "success",
        title: "Producto actualizado",
        timer: 1500,
        showConfirmButton: false
    });

    setTimeout(() => location.reload(), 1400);
}

async function addProduct() {
    const { value: form } = await Swal.fire({
        title: "Agregar Producto",
        background: "#111",
        color: "#fff",
        html: `
            <input id="new-name" class="swal2-input" placeholder="Nombre">
            <input id="new-desc" class="swal2-input" placeholder="Descripción">
            <input id="new-price" class="swal2-input" placeholder="Precio (ETH)">
            <input id="new-stock" class="swal2-input" placeholder="Stock">
            <input id="new-image" class="swal2-input" placeholder="URL Imagen">
        `,
        confirmButtonText: "Agregar",
        confirmButtonColor: "#facc15",
        showCancelButton: true,
        cancelButtonText: "Cancelar",
        preConfirm: () => ({
            name: document.getElementById("new-name").value,
            description: document.getElementById("new-desc").value,
            price: document.getElementById("new-price").value,
            stock: document.getElementById("new-stock").value,
            imageUrl: document.getElementById("new-image").value
        })
    });

    if (!form) return;

    Swal.fire({ title: "Creando...", didOpen: () => Swal.showLoading() });

    const res = await fetch("/api/wallet/products", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(form)
    });

    const data = await res.json();
    Swal.close();

    if (!data.success) {
        return Swal.fire("Error", data.error, "error");
    }

    Swal.fire({
        icon: "success",
        title: "Producto agregado",
        timer: 1500,
        showConfirmButton: false
    });

    setTimeout(() => location.reload(), 1500);
}

async function deleteProduct(id) {
    const confirm = await Swal.fire({
        title: "¿Eliminar producto?",
        text: "Esta acción no se puede deshacer",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Eliminar",
        cancelButtonText: "Cancelar"
    });

    if (!confirm.isConfirmed) return;

    const res = await fetch(`/api/wallet/products/${id}`, { method: "DELETE" });
    const data = await res.json();

    if (!data.success) {
        Swal.fire("Error", data.error || "No se pudo eliminar", "error");
    } else {
        Swal.fire("Eliminado", "El producto fue eliminado", "success");
        setTimeout(() => location.reload(), 1200);
    }
}

const withdrawBtn = document.getElementById("withdrawBtn");

  if (withdrawBtn) {
    withdrawBtn.addEventListener("click", async () => {
        const { value: amount } = await Swal.fire({
            title: "Retirar fondos",
            input: "text",
            inputLabel: "Cantidad en ETH a retirar",
            inputPlaceholder: "Ejemplo: 0.05",
            background: "#111",
            color: "#fff",
            showCancelButton: true,
            confirmButtonText: "Retirar",
            confirmButtonColor: "#facc15",
            cancelButtonText: "Cancelar",
            preConfirm: (val) => {
                if (!val || isNaN(val) || Number(val) <= 0) {
                    Swal.showValidationMessage("Ingresa un número válido mayor a 0");
                    return false;
                }
                return val;
            }
        });

        if (!amount) return;

        try {
            Swal.fire({
                title: "Procesando retiro...",
                background: "#111",
                color: "#fff",
                didOpen: () => Swal.showLoading(),
                allowOutsideClick: false
            });

            const res = await fetch("/api/wallet/withdraw", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ amount })
            });

            const data = await res.json();
            Swal.close();

            if (!data.success) {
                return Swal.fire({
                    icon: "error",
                    title: "Error al retirar",
                    text: data.message || "No se pudo completar el retiro",
                    background: "#111",
                    color: "#fff"
                });
            }

            Swal.fire({
                icon: "success",
                title: "Retiro completado",
                text: `Tx: ${data.txHash}`,
                background: "#111",
                color: "#fff",
                timer: 2000,
                showConfirmButton: false
            });

            const balRes = await fetch("/api/wallet/balance");
            const balData = await balRes.json();
            if (balData.success) {
                const span = document.getElementById("store-balance");
                if (span) span.textContent = `${balData.balance} ETH`;
            }

        } catch (err) {
            console.error(err);
            Swal.fire({
                icon: "error",
                title: "Error",
                text: err.message || "No se pudo conectar con el servidor",
                background: "#111",
                color: "#fff"
            });
        }
    });
  }
</script>

</body>
</html>
